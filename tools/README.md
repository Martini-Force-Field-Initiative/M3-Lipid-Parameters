# Tools

This directory contains reusable pieces of code usually used in simulation tests and data analysis.

It is encouraged to refactor code in a way that common pieces are contributed into this directory and
then utilized by other pieces of code, scripts or notebooks
rather than maintaining several independent copies or even different codes doing the same thing.

Same rules (documentation, meaningful file names...) as to simulation tests also apply here.


# Auto-generation tools

For the auto-generation tools here is how to use them - please note these are being developed and are very preliminary.

1) Create a single lipid itp with <code>lipid-itp-generator-Martini3-01.py</code>. The generic <code>-al</code> flag specifies the arguments. Examples:
- <code>./lipid-itp-generator-Martini3-01.py -alhead 'C P' -allink 'G G' -altail "CDCC cCCC"  -alname POPC -o v1-POPC-lipid.itp </code>
- <code>./lipid-itp-generator-Martini3-01.py -alhead 'E P' -allink 'G G' -altail "CDCC cCCC"  -alname POCE -o v1-POPE-lipid.itp </code>
- <code>./lipid-itp-generator-Martini3-01.py -alhead 'G P' -allink 'G G' -altail "CDCC cCCC"  -alname POPG -o v1-POPG-lipid.itp </code>
- <code>./lipid-itp-generator-Martini3-01.py -alhead 'PI'  -allink 'G G' -altail "DFFDD CCCC" -alname SDPI -o v1-SDPI-lipid.itp </code>

So far runs with the x40 tail combinations x5 headgroups PC, PE, PS, PG and PA as well as x10 tails for SM and CER and a few PI and PIP tails. 
Additionally, ether and plasmalogen lipids have been added with the same headgroup and tail combination as the glycerol ester phospholipids.
**WARNING**: only limited tested has been done for many of these lipids. 


2) Create .itp's for all/large number of lipids using <code>generate-from-table-v02.py</code>. Example:
- <code>python3 generate-from-table-v02.py -table CG-Martini3-lipids-naming-01.csv -makeItps yes -ofolder lipid_itps_v2/ </code>

**NOTE 1:** To choose a subset of lipids, copy <code>CG-Martini3-lipids-naming-01.xlsx</code>, select the desired lines, and save the table as .csv. Only lines with x and y in column 2 will be converted.

**NOTE 2:** For the PI and PIPs the full comments and inositol sugars parameters are NOT autogenerated and need to be manually copied over.

3) Setup simulations using <code>generate-from-table-v02.py </code>. Example using Martini 3:
- <code>python3 ../tools/generate-from-table-v02.py -table ../tools/CG-Martini3-lipids-naming-01_test5.csv -CBT no -baseLipid POPC -setupSims yes</code>

Example using Martini 2:
- <code>python3 ../tools/generate-from-table-v02-M2-side-copy.py -table ../tools/CG-Martini2-lipids-naming-comparsion-to-M3.csv -CBT no -baseLipid POPC -setupSims yes</code>

**NOTE 1:** fixed box size for all simulations, results in 100 lipids in each leaflet, but variable size of water box depending on lipid size.

**NOTE 2:** currently supports pure, POPC, DLPE and SSM-CHOL base where the x3 later mix 20% of lipid X into the base mixture

4) Run simulations: In run mode, <code>generate-from-table-v02.py</code> takes in the runner id and the number of runners that are running all the sims in this directory, e.g., one called the script runs all the simulation in current directory.
**NOTE:** internal thread pool used to specify how many at a given time (currently set to x16 with -nt 2 for the GROMACS run command - so needs a threaded install of GROMACS).
- <code>python3 ../tools/generate-from-table-v02.py -table ../tools/CG-Martini3-lipids-naming-01_test5.csv -sRunId 0 -sRunC 1 -runSims yes</code>

But if you want to split over many nodes easy to, run one <code>generate-from-table-v02.py</code> per node and adjust <code>-sRunId x -sRunC \<node count\></code>

5) Analysis of simulations: Run for one simulations - analysis pipeline uses x2 thread and has hardcoded variables - check <code>analysis_lipids.py</code>
**NOTE 1:** need to install MDAnalysis, DiffusionGLS (https://github.com/bio-phys/DiffusionGLS.git) + add new modification, and FATSLiM, also edit FATSLiM path
**NOTE 2:** the sim name is the <code>M3_noCBT_POPC_DLPA/</code> (need to include /)
Example:
- <code> python3 ../tools/analysis_pipeline/analysis_lipids.py M3_noCBT_POPC_DLPA/ </code>

To run the full set you can use <code>generate-from-table-v02.py</code>
- <code> python3 ../tools/generate-from-table-v02.py -table ../tools/CG-Martini3-lipids-naming-01_test5.csv -analyseSims yes </code>

6) Scripts for slurm submisison: In <code>tools/submit_slurm</code> there are example slurm sbatch submission script for setup, run (<code>submit_array.sh</code>) and analysis (for Martini 3 as well as Martini 2 with M2 suffix).
